import{r as c,C as $,q as k,v as K,y as q,d as w,j as e,a as v,F as z,aA as G,aB as I,t as H,T as L,B as T,I as S,m as P,s as E,aj as U,aC as V,g as _,ab as J,aD as Q,aE as B,aF as W,aa as X,aG as Y,k as j,aH as Z,aI as ee}from"./index.5e1275c5.js";import{P as te,d as ae}from"./dayjs.6774316b.js";var ne=globalThis&&globalThis.__rest||function(r,t){var o={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&t.indexOf(n)<0&&(o[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,n=Object.getOwnPropertySymbols(r);a<n.length;a++)t.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(r,n[a])&&(o[n[a]]=r[n[a]]);return o},se=function(t){var o=t.actions,n=t.author,a=t.avatar,i=t.children,s=t.className,u=t.content,f=t.prefixCls,p=t.datetime,g=ne(t,["actions","author","avatar","children","className","content","prefixCls","datetime"]),h=c.exports.useContext($),x=h.getPrefixCls,C=h.direction,m=function(b,R){return c.exports.createElement("div",{className:k("".concat(b,"-nested"))},R)},d=x("comment",f),D=a?c.exports.createElement("div",{className:"".concat(d,"-avatar")},typeof a=="string"?c.exports.createElement("img",{src:a,alt:"comment-avatar"}):a):null,F=o&&o.length?c.exports.createElement("ul",{className:"".concat(d,"-actions")},o.map(function(A,b){return c.exports.createElement("li",{key:"action-".concat(b)},A)})):null,l=(n||p)&&c.exports.createElement("div",{className:"".concat(d,"-content-author")},n&&c.exports.createElement("span",{className:"".concat(d,"-content-author-name")},n),p&&c.exports.createElement("span",{className:"".concat(d,"-content-author-time")},p)),y=c.exports.createElement("div",{className:"".concat(d,"-content")},l,c.exports.createElement("div",{className:"".concat(d,"-content-detail")},u),F),N=k(d,K({},"".concat(d,"-rtl"),C==="rtl"),s);return c.exports.createElement("div",q({},g,{className:N}),c.exports.createElement("div",{className:"".concat(d,"-inner")},D,y),i?m(d,i):null)},O=se;const re=()=>{const[r,t]=c.exports.useState(!1);return[r,n=>{if(n instanceof Promise)return new Promise((a,i)=>{t(!0),n.then(s=>{a(s),t(!1)}).catch(s=>{i(s),t(!1)})})}]};const{TextArea:oe}=S,M=({children:r,item:t,userInfo:o,articleId:n,commentId:a,replyId:i,replyVisible:s,onReply:u,commentList:f,setCommentList:p})=>{const{user:g}=t,[h,x]=c.exports.useState("");c.exports.useEffect(()=>{s&&x("")},[s]);const C=l=>{x(l.target.value)},m=()=>{if(!o.userId)return P.warn("\u60A8\u672A\u767B\u9646\uFF0C\u8BF7\u767B\u5F55\u540E\u518D\u8BD5\u3002");E.post("/discuss",{userId:o.userId,articleId:n,content:h.trim(),commentId:a}).then(l=>{u({commentId:0,replyId:0}),p(l.rows)})},d=l=>{l.ctrlKey&&l.keyCode===13&&m()},D=()=>{i?E.delete(`/discuss/reply/${i}`).then(()=>{const l=[...f],y=l.find(N=>N.id===a);y.replies=y.replies.filter(N=>N.id!==i),p(l)}):E.delete(`/discuss/comment/${a}`).then(()=>{let l=[...f];l=l.filter(y=>y.id!==a),p(l)})};return v(O,{actions:[e("span",{onClick:()=>{u({commentId:a,replyId:i})},children:"Reply to"}),e(z,{children:o.role===1&&e(te,{title:"\u662F\u5426\u5220\u9664\u8BE5\u7559\u8A00\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u8BA4",onConfirm:D,children:e(G,{className:"icon-delete"})})})],author:e("span",{children:g&&g.username}),avatar:e(I,{userInfo:g}),content:e("div",{className:"article-detail",dangerouslySetInnerHTML:{__html:H(t.content,!0)}}),datetime:e(L,{title:t.createdAt,children:e("span",{children:ae(t.createdAt).fromNow()})}),children:[s&&v("div",{className:"reply-form",children:[e(oe,{placeholder:`\u56DE\u590D${t.user.username}...`,value:h,onChange:C,onKeyUp:d}),v("div",{className:"reply-form-controls",children:[e("span",{className:"tip",children:"Ctrl or \u2318 + Enter"}),e(T,{htmlType:"submit",type:"primary",disabled:!h.trim(),onClick:m,children:"\u56DE\u590D"})]})]}),r]})},ce=({commentList:r,articleId:t,setCommentList:o})=>{const n=w(s=>s.user),[a,i]=c.exports.useState({commentId:0,replyId:0});return e("div",{children:r.map(s=>e(M,{item:s,articleId:t,userInfo:n,commentId:s.id,setCommentList:o,commentList:r,onReply:i,replyVisible:a.commentId===s.id&&!a.replyId,children:s.replies.map(u=>e(M,{item:u,articleId:t,userInfo:n,commentId:s.id,replyId:u.id,setCommentList:o,commentList:r,onReply:i,replyVisible:a.commentId===s.id&&a.replyId===u.id},u.id))},s.id))})};const{TextArea:ie}=S,le=({onChange:r,onSubmit:t,submitting:o,value:n,articleId:a})=>v("div",{children:[e(j.Item,{children:e(ie,{rows:4,placeholder:"\u8BF4\u70B9\u4EC0\u4E48...",onChange:r,value:n})}),e(j.Item,{children:v("div",{className:"controls",children:[e(Z,{className:"controls-tip-icon"}),e("span",{className:"controls-tip",children:"\u652F\u6301 Markdown \u8BED\u6CD5"}),e(T,{className:"disscus-btn",htmlType:"submit",loading:o,onClick:t,type:"primary",children:a!==-1?"\u6DFB\u52A0\u8BC4\u8BBA":"\u7559\u8A00"})]})})]}),ue=({setCommentList:r,articleId:t,commentList:o})=>{const n=V(),a=_(),i=w(m=>m.user),{username:s}=i,[u,f]=c.exports.useState(""),[p,g]=re(),h=m=>{switch(m.key){case"login":a.emit("openSignModal","login");break;case"register":a.emit("openSignModal","register");break;case"loginout":n(ee());break}},x=()=>{if(!!u){if(!i.username)return P.warn("\u60A8\u672A\u767B\u9646\uFF0C\u8BF7\u767B\u5F55\u540E\u518D\u8BD5\u3002");g(E.post("/discuss",{articleId:t,content:u,userId:i.userId})).then(m=>{f(""),r(m.rows)})}},C=()=>s?e(B,{onClick:h,children:e(B.Item,{children:"\u6CE8\u9500"},"loginout")}):v(B,{onClick:h,children:[e(B.Item,{children:"\u767B\u5F55"},"login"),e(B.Item,{children:"\u6CE8\u518C"},"register")]});return v("div",{id:"discuss",children:[v("div",{className:"discuss-header",children:[e("span",{className:"discuss-count",children:J(o)}),t!==-1?"\u6761\u8BC4\u8BBA":"\u6761\u7559\u8A00",e("span",{className:"discuss-user",children:e(Q,{overlay:C(),trigger:["click","hover"],children:v("span",{children:[s||"\u672A\u767B\u5F55\u7528\u6237",e(W,{})]})})}),e(X,{className:"hr"})]}),e(O,{avatar:s?e(I,{userInfo:i}):e(Y,{style:{fontSize:32,margin:"5px 5px 0 0"}}),content:e(le,{onChange:m=>f(m.target.value),onSubmit:x,submitting:p,value:u,articleId:t})}),e(ce,{commentList:o,articleId:t,setCommentList:r})]})};ue.propTypes={commentList:U.array.isRequired};export{ue as D,re as u};
